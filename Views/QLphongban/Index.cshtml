<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qu·∫£n l√Ω Ph√≤ng ban - HRM (Full)</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- jsPDF + autotable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- SheetJS (Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- FileSaver -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
  body { background:#f4f7ff; }
  .card-custom { border-radius:12px; border:none; box-shadow:0 6px 20px rgba(20,40,80,0.08); }
  .table tbody tr:hover { background:#eef6ff; }
  .thumb { width:44px; height:44px; object-fit:cover; border-radius:8px; }
  .action-btn { border-radius:8px; padding:6px 9px; box-shadow:0 2px 6px rgba(0,0,0,0.08); transition:.15s; }
  .action-btn:hover { transform:translateY(-2px); }
  .spinner-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.6); z-index:99999; }
  th.sortable { cursor:pointer; user-select:none; }
  .small-muted { font-size:.85rem; color:#6c757d; }
  .table-fixed { table-layout:fixed; word-wrap:break-word; }
</style>
</head>
<body class="p-4">

<div id="spinner" class="spinner-overlay" style="display:none;">
  <div class="text-center">
    <div class="spinner-border text-primary" role="status" style="width:3.2rem;height:3.2rem"></div>
    <div class="mt-2 fw-semibold">ƒêang t·∫£i...</div>
  </div>
</div>

<div class="container">
  <div class="card card-custom p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0 text-primary"><i class="bi bi-building"></i> Qu·∫£n l√Ω Ph√≤ng ban</h3>
      <div>
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#modalAdd">
          <i class="bi bi-plus-circle"></i> Th√™m ph√≤ng
        </button>
        <div class="btn-group" role="group">
          <button class="btn btn-outline-primary" onclick="exportExcel()">üì§ Excel</button>
          <button class="btn btn-outline-danger" onclick="exportPDF()">üìÑ PDF</button>
          <button class="btn btn-outline-secondary" onclick="exportCSV()">üìë CSV</button>
          <button class="btn btn-outline-dark" onclick="exportWord()">üìò Word</button>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="row g-2 mb-3">
      <div class="col-md-4">
        <input id="searchInput" class="form-control" placeholder="üîç T√¨m m√£ / t√™n ph√≤ng..." />
      </div>
      <div class="col-md-3">
        <select id="filterHasAvatar" class="form-select">
          <option value="all">‚Äî T·∫•t c·∫£ (·∫£nh tr∆∞·ªüng ph√≤ng) ‚Äî</option>
          <option value="with">C√≥ avatar</option>
          <option value="without">Ch∆∞a c√≥ avatar</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="pageSize" class="form-select">
          <option value="4">4 h√†ng / trang</option>
          <option value="6" selected>6 h√†ng / trang</option>
          <option value="10">10 h√†ng / trang</option>
        </select>
      </div>
      <div class="col-md-2 text-end small-muted">
        T·ªïng: <span id="totalCount">0</span> ph√≤ng
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover table-fixed align-middle">
        <thead class="table-light">
          <tr>
            <th class="sortable" onclick="sortBy('ma')">M√£ <i id="icon-ma"></i></th>
            <th>·∫¢nh</th>
            <th class="sortable" onclick="sortBy('ten')">T√™n ph√≤ng <i id="icon-ten"></i></th>
            <th>M√¥ t·∫£</th>
            <th class="sortable" onclick="sortBy('soNV')">S·ªë NV <i id="icon-soNV"></i></th>
            <th class="text-center">Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <nav>
      <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>

  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1050">
  <div id="toastEl" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastText">Th√†nh c√¥ng</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- Modal Add -->
<div class="modal fade" id="modalAdd" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Th√™m ph√≤ng ban</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formAdd">
          <div class="row g-2">
            <div class="col-md-3">
              <label class="form-label">M√£ ph√≤ng</label>
              <input id="addMa" class="form-control" required />
            </div>
            <div class="col-md-5">
              <label class="form-label">T√™n ph√≤ng</label>
              <input id="addTen" class="form-control" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">S·ªë nh√¢n vi√™n</label>
              <input id="addSoNV" type="number" min="0" value="0" class="form-control" />
            </div>

            <div class="col-md-6">
              <label class="form-label">Tr∆∞·ªüng ph√≤ng</label>
              <input id="addTruong" class="form-control" placeholder="T√™n tr∆∞·ªüng ph√≤ng (t√πy ch·ªçn)" />
            </div>

            <div class="col-md-6">
              <label class="form-label">·∫¢nh tr∆∞·ªüng ph√≤ng (avatar)</label>
              <input id="addAvatar" type="file" accept="image/*" class="form-control" />
            </div>

            <div class="col-12">
              <label class="form-label">M√¥ t·∫£</label>
              <textarea id="addMoTa" class="form-control" rows="3"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <button class="btn btn-success" onclick="handleAdd()">L∆∞u & Th√™m</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Edit -->
<div class="modal fade" id="modalEdit" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> S·ª≠a ph√≤ng ban</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formEdit">
          <input id="editIndex" type="hidden" />
          <div class="row g-2">
            <div class="col-md-3">
              <label class="form-label">M√£ ph√≤ng</label>
              <input id="editMa" class="form-control" disabled />
            </div>
            <div class="col-md-5">
              <label class="form-label">T√™n ph√≤ng</label>
              <input id="editTen" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">S·ªë nh√¢n vi√™n</label>
              <input id="editSoNV" type="number" min="0" class="form-control" />
            </div>

            <div class="col-md-6">
              <label class="form-label">Tr∆∞·ªüng ph√≤ng</label>
              <input id="editTruong" class="form-control" />
            </div>

            <div class="col-md-6">
              <label class="form-label">·∫¢nh tr∆∞·ªüng ph√≤ng</label>
              <input id="editAvatar" type="file" accept="image/*" class="form-control" />
              <div class="mt-2"><img id="editPreview" class="thumb" src="" alt=""></div>
            </div>

            <div class="col-12">
              <label class="form-label">M√¥ t·∫£</label>
              <textarea id="editMoTa" class="form-control" rows="3"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <button class="btn btn-warning" onclick="handleSaveEdit()">L∆∞u thay ƒë·ªïi</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Delete Confirm -->
<div class="modal fade" id="modalDelete" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-trash"></i> X√≥a ph√≤ng</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a <strong id="delName"></strong> ( <span id="delMa"></span> ) ?</p>
        <input id="delIndex" type="hidden" />
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <button class="btn btn-danger" onclick="handleDelete()">X√≥a</button>
      </div>
    </div>
  </div>
</div>

<!-- View Modal (chi ti·∫øt) -->
<div class="modal fade" id="modalView" tabindex="-1">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Chi ti·∫øt ph√≤ng ban</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex gap-3">
          <img id="viewAvatar" class="thumb" src="" alt="">
          <div>
            <h5 id="viewTen"></h5>
            <div class="small-muted">M√£: <span id="viewMa"></span></div>
            <div class="small-muted">Tr∆∞·ªüng ph√≤ng: <span id="viewTruong"></span></div>
            <div class="small-muted">S·ªë NV: <span id="viewSoNV"></span></div>
          </div>
        </div>
        <hr>
        <div id="viewMoTa" class="small-muted"></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* -------------------------
  Data & State
------------------------- */
let data = [
  { ma:"PB01", ten:"Ph√≤ng K·∫ø To√°n", mota:"Qu·∫£n l√Ω s·ªï s√°ch, b√°o c√°o", soNV:10, truong:"Tr·∫ßn VƒÉn H√πng", avatar:"", created:new Date().toISOString() },
  { ma:"PB02", ten:"Ph√≤ng Nh√¢n S·ª±", mota:"Tuy·ªÉn d·ª•ng, ch√≠nh s√°ch", soNV:8, truong:"Ph·∫°m VƒÉn Minh", avatar:"", created:new Date().toISOString() },
  { ma:"PB03", ten:"Ph√≤ng K·ªπ Thu·∫≠t", mota:"D·ª± √°n k·ªπ thu·∫≠t", soNV:12, truong:"L√™ Ho√†ng", avatar:"", created:new Date().toISOString() },
  { ma:"PB04", ten:"Ph√≤ng IT", mota:"H·∫° t·∫ßng & dev", soNV:6, truong:"Nguy·ªÖn Th·ªã H√≤a", avatar:"", created:new Date().toISOString() },
  { ma:"PB05", ten:"Ph√≤ng Marketing", mota:"Qu·∫£ng c√°o & content", soNV:9, truong:"V√µ Qu·ªëc Kh√°nh", avatar:"", created:new Date().toISOString() },
  { ma:"PB06", ten:"Ph√≤ng CSKH", mota:"H·ªó tr·ª£ kh√°ch h√†ng", soNV:9, truong:"Nguy·ªÖn M·ªπ Dung", avatar:"", created:new Date().toISOString() }
];

let currentPage = 1;
let pageSize = Number(document.getElementById('pageSize').value);
let sortColumn = null; // 'ma' | 'ten' | 'soNV'
let sortDir = 1; // 1 asc, -1 desc

/* -------------------------
  Helper UI
------------------------- */
const spinner = document.getElementById('spinner');
function showSpinner(){ spinner.style.display='flex'; }
function hideSpinner(){ spinner.style.display='none'; }

const toastEl = new bootstrap.Toast(document.getElementById('toastEl'));
function showToast(msg, type='success'){
  document.getElementById('toastText').innerText = msg;
  const el = document.getElementById('toastEl');
  el.className = 'toast align-items-center border-0'; // reset
  if(type==='success') el.classList.add('text-bg-success');
  else if(type==='error') el.classList.add('text-bg-danger');
  else el.classList.add('text-bg-secondary');
  toastEl.show();
}

/* -------------------------
  Rendering, Filtering, Sorting, Pagination
------------------------- */
function getFilteredSorted() {
  let q = document.getElementById('searchInput').value.trim().toLowerCase();
  let filterAvatar = document.getElementById('filterHasAvatar').value; // all/with/without

  let result = data.slice();

  if(q) {
    result = result.filter(x => (x.ma||'').toLowerCase().includes(q) || (x.ten||'').toLowerCase().includes(q) || (x.truong||'').toLowerCase().includes(q));
  }

  if(filterAvatar === 'with') result = result.filter(x => x.avatar);
  if(filterAvatar === 'without') result = result.filter(x => !x.avatar);

  if(sortColumn) {
    result.sort((a,b) => {
      let A = a[sortColumn], B = b[sortColumn];
      if(typeof A === 'string') A = A.toLowerCase();
      if(typeof B === 'string') B = B.toLowerCase();
      if(A == null) A = '';
      if(B == null) B = '';
      if(A < B) return -1 * sortDir;
      if(A > B) return 1 * sortDir;
      return 0;
    });
  }

  return result;
}

function renderTable() {
  pageSize = Number(document.getElementById('pageSize').value);
  let arr = getFilteredSorted();
  const total = arr.length;
  document.getElementById('totalCount').innerText = total;

  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  if(currentPage > totalPages) currentPage = totalPages;

  const start = (currentPage - 1) * pageSize;
  const pageData = arr.slice(start, start + pageSize);

  let html = '';
  pageData.forEach((r, idx) => {
    html += `<tr>
      <td style="width:100px">${r.ma}</td>
      <td style="width:72px">${r.avatar ? `<img src="${r.avatar}" class="thumb" alt="">` : `<div class="text-muted small">‚Äî</div>`}</td>
      <td style="min-width:200px">${escapeHtml(r.ten)}<div class="small-muted">${escapeHtml(r.truong)}</div></td>
      <td>${escapeHtml(r.mota)}</td>
      <td style="width:120px">${r.soNV ?? ''}</td>
      <td class="text-center" style="width:170px">
        <button class="btn btn-sm btn-info action-btn me-1" title="Xem" onclick="openView(${start+idx})"><i class="bi bi-eye"></i></button>
        <button class="btn btn-sm btn-warning action-btn me-1" title="S·ª≠a" onclick="openEdit(${start+idx})"><i class="bi bi-pencil-square"></i></button>
        <button class="btn btn-sm btn-danger action-btn me-1" title="X√≥a" onclick="openDelete(${start+idx})"><i class="bi bi-trash"></i></button>
        <button class="btn btn-sm btn-secondary action-btn" title="Nh√¢n s·ª±" onclick="openStaff(${start+idx})"><i class="bi bi-people"></i></button>
      </td>
    </tr>`;
  });

  document.getElementById('tableBody').innerHTML = html;
  renderPagination(totalPages);
  updateSortIcons();
}

function renderPagination(totalPages) {
  let html = '';
  for(let i=1;i<=totalPages;i++){
    html += `<li class="page-item ${i===currentPage ? 'active' : ''}"><a class="page-link" onclick="goPage(${i})">${i}</a></li>`;
  }
  document.getElementById('pagination').innerHTML = html;
}

function goPage(p){ currentPage = p; renderTable(); }

function escapeHtml(t){ if(t==null) return ''; return String(t).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function sortBy(col){
  if(sortColumn === col) sortDir = -sortDir;
  else { sortColumn = col; sortDir = 1; }
  currentPage = 1;
  renderTable();
}

function updateSortIcons(){
  ['ma','ten','soNV'].forEach(c=> {
    const el = document.getElementById('icon-'+c);
    if(!el) return;
    el.innerHTML = '';
    if(sortColumn === c) el.innerHTML = sortDir===1 ? ' ‚ñ≤' : ' ‚ñº';
  });
}

/* -------------------------
  CRUD Handlers
------------------------- */
async function handleAdd(){
  const ma = document.getElementById('addMa').value.trim();
  const ten = document.getElementById('addTen').value.trim();
  if(!ma || !ten){ showToast('Vui l√≤ng nh·∫≠p m√£ & t√™n ph√≤ng', 'error'); return; }
  showSpinner();
  const soNV = Number(document.getElementById('addSoNV').value) || 0;
  const truong = document.getElementById('addTruong').value.trim();
  const mota = document.getElementById('addMoTa').value.trim();
  const file = document.getElementById('addAvatar').files[0];
  const avatar = file ? await fileToDataURL(file) : '';

  // // Example real API call (uncomment and modify URL when backend ready)
  // const resp = await fetch('/api/departments', {
  //   method: 'POST',
  //   headers: {'Content-Type':'application/json'},
  //   body: JSON.stringify({ma,ten,mota,soNV,truong,avatar})
  // });
  // const created = await resp.json();

  // mock create:
  await delay(600);
  data.unshift({ ma, ten, mota, soNV, truong, avatar, created:new Date().toISOString() });

  hideSpinner();
  showToast('ƒê√£ th√™m ph√≤ng ban');
  bootstrap.Modal.getInstance(document.getElementById('modalAdd')).hide();
  document.getElementById('formAdd').reset();
  currentPage = 1;
  renderTable();
}

function openEdit(index){
  const item = data[index];
  if(!item) return;
  document.getElementById('editIndex').value = index;
  document.getElementById('editMa').value = item.ma;
  document.getElementById('editTen').value = item.ten;
  document.getElementById('editSoNV').value = item.soNV ?? '';
  document.getElementById('editTruong').value = item.truong ?? '';
  document.getElementById('editMoTa').value = item.mota ?? '';
  document.getElementById('editPreview').src = item.avatar || '';
  new bootstrap.Modal(document.getElementById('modalEdit')).show();
}

async function handleSaveEdit(){
  const idx = Number(document.getElementById('editIndex').value);
  const item = data[idx];
  if(!item) return;
  showSpinner();
  const ten = document.getElementById('editTen').value.trim();
  const soNV = Number(document.getElementById('editSoNV').value) || 0;
  const truong = document.getElementById('editTruong').value.trim();
  const mota = document.getElementById('editMoTa').value.trim();
  const file = document.getElementById('editAvatar').files[0];
  if(file){
    item.avatar = await fileToDataURL(file);
  }
  item.ten = ten; item.soNV = soNV; item.truong = truong; item.mota = mota;

  // // Example API PUT:
  // await fetch('/api/departments/' + item.ma, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(item) });

  await delay(500);
  hideSpinner();
  showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng');
  bootstrap.Modal.getInstance(document.getElementById('modalEdit')).hide();
  renderTable();
}

function openDelete(index){
  const item = data[index];
  if(!item) return;
  document.getElementById('delIndex').value = index;
  document.getElementById('delName').innerText = item.ten;
  document.getElementById('delMa').innerText = item.ma;
  new bootstrap.Modal(document.getElementById('modalDelete')).show();
}

async function handleDelete(){
  const idx = Number(document.getElementById('delIndex').value);
  const item = data[idx];
  if(!item) return;
  showSpinner();
  // // API DELETE example:
  // await fetch('/api/departments/' + item.ma, { method:'DELETE' });

  await delay(400);
  data.splice(idx, 1);
  hideSpinner();
  showToast('ƒê√£ x√≥a');
  bootstrap.Modal.getInstance(document.getElementById('modalDelete')).hide();
  renderTable();
}

function openView(index){
  const item = data[index];
  if(!item) return;
  document.getElementById('viewAvatar').src = item.avatar || '';
  document.getElementById('viewTen').innerText = item.ten;
  document.getElementById('viewMa').innerText = item.ma;
  document.getElementById('viewTruong').innerText = item.truong || '-';
  document.getElementById('viewSoNV').innerText = item.soNV ?? '-';
  document.getElementById('viewMoTa').innerText = item.mota || '';
  new bootstrap.Modal(document.getElementById('modalView')).show();
}

/* optional action on "Nh√¢n s·ª±" button */
function openStaff(index){
  const item = data[index];
  alert(`B·∫°n b·∫•m "Nh√¢n s·ª±" c·ªßa ${item.ten} ‚Äî ƒë√¢y l√† ch·ªó ƒë·ªÉ chuy·ªÉn sang trang qu·∫£n l√Ω nh√¢n vi√™n c·ªßa ph√≤ng n√†y.`);
}

/* -------------------------
  Export: CSV / Excel / PDF / Word
------------------------- */
function exportCSV(){
  const rows = getFilteredSorted().map(x => [x.ma, x.ten, x.truong||'', x.soNV||'', x.mota||'']);
  const header = ['M√£','T√™n ph√≤ng','Tr∆∞·ªüng ph√≤ng','S·ªë NV','M√¥ t·∫£'];
  downloadCSV([header, ...rows], 'PhongBan.csv');
}

function downloadCSV(rows, filename){
  const bom = '\uFEFF';
  const csv = rows.map(r => r.map(c => `"${String(c ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  saveAs(blob, filename);
}

function exportExcel(){
  const wb = XLSX.utils.book_new();
  const rows = getFilteredSorted().map(x => ({ M√£:x.ma, T√™n:x.ten, Tr∆∞·ªüng:x.truong, S·ªëNV:x.soNV, M√¥_t·∫£:x.mota }));
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Ph√≤ng_ban');
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  saveAs(new Blob([wbout],{type:'application/octet-stream'}), 'PhongBan.xlsx');
}

function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape'});
  const arr = getFilteredSorted().map(x => [x.ma, x.ten, x.truong || '', x.soNV || '', x.mota || '']);
  doc.autoTable({ head:[['M√£','T√™n ph√≤ng','Tr∆∞·ªüng ph√≤ng','S·ªë NV','M√¥ t·∫£']], body: arr, styles:{fontSize:9} });
  doc.save('PhongBan.pdf');
}

function exportWord(){
  const rows = getFilteredSorted();
  let html = '<html><head><meta charset="utf-8"/></head><body><h3>Danh s√°ch ph√≤ng ban</h3><table border="1" style="border-collapse:collapse">';
  html += '<tr><th>M√£</th><th>T√™n</th><th>Tr∆∞·ªüng</th><th>S·ªë NV</th><th>M√¥ t·∫£</th></tr>';
  rows.forEach(r => { html += `<tr><td>${r.ma}</td><td>${escapeHtml(r.ten)}</td><td>${escapeHtml(r.truong||'')}</td><td>${r.soNV||''}</td><td>${escapeHtml(r.mota||'')}</td></tr>`; });
  html += '</table></body></html>';
  const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
  saveAs(blob, 'PhongBan.doc');
}

/* -------------------------
  Utilities
------------------------- */
function delay(ms){ return new Promise(res => setTimeout(res, ms)); }

function fileToDataURL(file){
  return new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = e => res(e.target.result);
    fr.onerror = e => rej(e);
    fr.readAsDataURL(file);
  });
}

/* -------------------------
  Events
------------------------- */
document.getElementById('searchInput').addEventListener('input', debounce(()=>{ currentPage = 1; renderTable(); }, 220));
document.getElementById('filterHasAvatar').addEventListener('change', ()=>{ currentPage=1; renderTable(); });
document.getElementById('pageSize').addEventListener('change', ()=>{ currentPage=1; renderTable(); });
document.getElementById('editAvatar').addEventListener('change', function(){ const f=this.files[0]; if(!f) return; fileToDataURL(f).then(d=>document.getElementById('editPreview').src=d); });

function debounce(fn, t){ let h; return (...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a), t); }; }

/* -------------------------
  Init
------------------------- */
renderTable();

/* -------------------------
  Small helpers for paging outside functions
------------------------- */
function goPage(p){ currentPage = p; renderTable(); }

/* -------------------------
  Mock API examples & Notes
-------------------------
- Khi chuy·ªÉn sang ASP.NET Core, thay ph·∫ßn mock (delay + array ops) b·∫±ng:
  - GET:  fetch('/api/departments') -> load data
  - POST: fetch('/api/departments', {method:'POST', body: JSON.stringify(newItem)})
  - PUT: fetch('/api/departments/{ma}', {method:'PUT', body: JSON.stringify(item)})
  - DELETE: fetch('/api/departments/{ma}', {method:'DELETE'})
- V·ªõi file (avatar) b·∫°n c√≥ 2 c√°ch:
  - L∆∞u DataURL (nh∆∞ hi·ªán t·∫°i) ‚Äî ti·ªán demo, KH√îNG d√πng cho production.
  - Upload file l√™n server (multipart/form-data), server l∆∞u file v√† tr·∫£ URL; client d√πng URL ƒë√≥.
------------------------- */

</script>
</body>
</html>

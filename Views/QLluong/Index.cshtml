@{
    ViewData["Title"] = "Qu·∫£n l√Ω l∆∞∆°ng nh√¢n vi√™n";
    Layout = "~/Views/Shared/_Layout.cshtml"; 
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

<style>
    :root {
        --main-blue: #1d72b8; /* M√†u xanh ch·ªß ƒë·∫°o */
        --dark-blue: #155d8b;
        --light-bg: #f4f7fa; /* N·ªÅn Dashboard nh·∫π nh√†ng */
        --salary-green: #198754; /* Xanh l√° cho s·ªë ti·ªÅn */
    }
    body {
        background-color: var(--light-bg);
        font-family: "Segoe UI", sans-serif;
    }

    .salary-dashboard {
        max-width: 1500px;
        margin: 30px auto;
        padding: 0 15px;
    }
    
    /* Thi·∫øt k·∫ø Card ch√≠nh */
    .card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 6px 15px rgba(0,0,0,0.08); /* Shadow r√µ h∆°n */
        background: white;
    }

    /* Ti√™u ƒë·ªÅ b·∫£ng */
    .table th {
        background-color: var(--main-blue);
        color: white;
        text-align: center;
        border-color: #ffffff33 !important; /* Vi·ªÅn tr·∫Øng nh·∫°t */
    }

    /* C·ªôt s·ªë ti·ªÅn */
    .salary-cell {
        font-weight: 700;
        color: var(--salary-green);
        text-align: right !important; /* CƒÉn ph·∫£i cho s·ªë ti·ªÅn */
        padding-right: 15px;
    }
    
    /* Input Ng√†y l√†m */
    .ngay-lam {
        max-width: 100px;
        margin: 0 auto;
    }

    /* C√°c n√∫t ch·ª©c nƒÉng */
    .btn-primary {
        background-color: var(--main-blue);
        border: none;
        font-weight: 600;
    }
    .btn-primary:hover {
        background-color: var(--dark-blue);
    }
    .btn-success {
        background-color: var(--salary-green);
        border: none;
        font-weight: 600;
    }
    .btn-success:hover {
        background-color: #146c43;
    }
    
    /* KPI Cards - M·ªõi */
    .kpi-card {
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        border-left: 5px solid var(--main-blue);
    }
    .kpi-card h4 {
        font-weight: 700;
        margin-top: 5px;
        color: var(--main-blue);
    }
    .kpi-card p {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .kpi-card .display-6 {
        font-weight: 800;
        color: var(--main-blue);
    }
</style>

<div class="container-fluid salary-dashboard">
    <h3 class="fw-bold mb-4 text-dark"><i class="fa-solid fa-calculator me-2 text-primary"></i> Qu·∫£n l√Ω & T√≠nh l∆∞∆°ng Nh√¢n vi√™n</h3>

    <div class="row g-4 mb-5">
        <div class="col-lg-4 col-md-6">
            <div class="card kpi-card border-left-blue">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-users fa-2x text-primary me-3"></i>
                    <div>
                        <p class="mb-0">T·ªïng s·ªë Nh√¢n vi√™n</p>
                        <h4 class="display-6" id="kpiTotalEmployees">5</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card kpi-card border-left-green">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-calendar-days fa-2x text-info me-3"></i>
                    <div>
                        <p class="mb-0">K·ª≥ l∆∞∆°ng th√°ng</p>
                        <h4 class="display-6 text-info" id="kpiCurrentMonth">11/2025</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-12">
            <div class="card kpi-card border-left-warning">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-coins fa-2x text-success me-3"></i>
                    <div>
                        <p class="mb-0">T·ªïng l∆∞∆°ng c·∫ßn chi tr·∫£</p>
                        <h4 class="display-6 text-success" id="kpiTotalSalary">0 VNƒê</h4> 
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-header bg-white p-4">
            <div class="d-flex justify-content-between align-items-center">
                 <h4 class="mb-0 text-dark">B·∫¢NG CH·∫§M C√îNG V√Ä T√çNH L∆Ø∆†NG</h4>
                 <div class="d-flex">
                    <button class="btn btn-success me-2" id="btnTinhLuong">
                        <i class="fa-solid fa-dollar-sign me-1"></i> T√≠nh l∆∞∆°ng
                    </button>
                    <button class="btn btn-primary" id="btnXuatLuong">
                        <i class="fa-solid fa-file-excel me-1"></i> Xu·∫•t b·∫£ng l∆∞∆°ng
                    </button>
                </div>
            </div>
        </div>

        <div class="card-body p-4 pt-0">
            <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle" id="tableLuong">
                    <thead>
                        <tr>
                            <th>M√£ NV</th>
                            <th>H·ªç t√™n</th>
                            <th>Ch·ª©c v·ª•</th>
                            <th>Ng√†y l√†m vi·ªác</th>
                            <th class="text-right">L∆∞∆°ng/ng√†y (VNƒê)</th>
                            <th class="text-right">T·ªïng l∆∞∆°ng (VNƒê)</th>
                        </tr>
                    </thead>
                    <tbody id="bangChamCong">
                        <tr>
                            <td class="text-center">NV01</td>
                            <td>Nguy·ªÖn VƒÉn An</td>
                            <td class="text-center">Nh√¢n vi√™n IT</td>
                            <td class="text-center"><input type="number" class="form-control text-center ngay-lam" value="26"></td>
                            <td class="luong-ngay text-right" data-value="500000">500.000</td>
                            <td class="tong-luong salary-cell">0</td>
                        </tr>
                        <tr>
                            <td class="text-center">NV02</td>
                            <td>Tr·∫ßn Th·ªã B√≠ch</td>
                            <td class="text-center">K·∫ø to√°n</td>
                            <td class="text-center"><input type="number" class="form-control text-center ngay-lam" value="24"></td>
                            <td class="luong-ngay text-right" data-value="450000">450.000</td>
                            <td class="tong-luong salary-cell">0</td>
                        </tr>
                        <tr>
                            <td class="text-center">NV03</td>
                            <td>L√™ Minh Ch√¢u</td>
                            <td class="text-center">Nh√¢n s·ª±</td>
                            <td class="text-center"><input type="number" class="form-control text-center ngay-lam" value="28"></td>
                            <td class="luong-ngay text-right" data-value="480000">480.000</td>
                            <td class="tong-luong salary-cell">0</td>
                        </tr>
                        <tr>
                            <td class="text-center">NV04</td>
                            <td>Ph·∫°m VƒÉn D≈©ng</td>
                            <td class="text-center">Tr∆∞·ªüng ph√≤ng IT</td>
                            <td class="text-center"><input type="number" class="form-control text-center ngay-lam" value="25"></td>
                            <td class="luong-ngay text-right" data-value="700000">700.000</td>
                            <td class="tong-luong salary-cell">0</td>
                        </tr>
                        <tr>
                            <td class="text-center">NV05</td>
                            <td>Nguy·ªÖn Th·ªã H·ªìng</td>
                            <td class="text-center">Th∆∞ k√Ω</td>
                            <td class="text-center"><input type="number" class="form-control text-center ngay-lam" value="27"></td>
                            <td class="luong-ngay text-right" data-value="420000">420.000</td>
                            <td class="tong-luong salary-cell">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer text-end text-muted">
            <i class="fa-solid fa-info-circle me-1"></i> D·ªØ li·ªáu ch·ªâ mang t√≠nh ch·∫•t minh h·ªça. Vui l√≤ng nh·∫•n "T√≠nh l∆∞∆°ng" ƒë·ªÉ c·∫≠p nh·∫≠t k·∫øt qu·∫£.
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>


<script>
    let luongDaTinh = false;

    // H√†m ƒë·ªãnh d·∫°ng s·ªë ti·ªÅn VND
    function formatCurrency(number) {
        return number.toLocaleString("vi-VN") + " ‚Ç´";
    }

    // === CH·ª®C NƒÇNG T√çNH L∆Ø∆†NG ===
    document.getElementById("btnTinhLuong").addEventListener("click", function () {
        const rows = document.querySelectorAll("#bangChamCong tr");
        let tongLuongChuaTra = 0;

        rows.forEach(row => {
            const ngayLam = parseInt(row.querySelector(".ngay-lam").value) || 0;
            // L·∫•y gi√° tr·ªã g·ªëc t·ª´ data-value thay v√¨ textContent ƒë·ªÉ tr√°nh l·ªói ƒë·ªãnh d·∫°ng
            const luongNgay = parseInt(row.querySelector(".luong-ngay").getAttribute("data-value")) || 0; 
            
            const tongLuong = ngayLam * luongNgay;
            
            // C·∫≠p nh·∫≠t t·ªïng l∆∞∆°ng v√†o b·∫£ng
            row.querySelector(".tong-luong").textContent = formatCurrency(tongLuong);
            tongLuongChuaTra += tongLuong;
        });

        // C·∫≠p nh·∫≠t KPI t·ªïng l∆∞∆°ng
        document.getElementById("kpiTotalSalary").textContent = formatCurrency(tongLuongChuaTra);

        luongDaTinh = true;
        alert("‚úÖ ƒê√£ t√≠nh xong l∆∞∆°ng cho nh√¢n vi√™n! T·ªïng l∆∞∆°ng c·∫ßn chi tr·∫£: " + formatCurrency(tongLuongChuaTra));
    });

    // === CH·ª®C NƒÇNG XU·∫§T EXCEL ===
    document.getElementById("btnXuatLuong").addEventListener("click", async function () {
        if (!luongDaTinh) {
            alert("‚ö†Ô∏è Vui l√≤ng t√≠nh l∆∞∆°ng tr∆∞·ªõc khi xu·∫•t b·∫£ng!");
            return;
        }

        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet("BangLuong");

        // Ti√™u ƒë·ªÅ
        const headers = ["M√£ NV", "H·ªç t√™n", "Ch·ª©c v·ª•", "Ng√†y l√†m vi·ªác", "L∆∞∆°ng/ng√†y (VNƒê)", "T·ªïng l∆∞∆°ng (VNƒê)"];
        worksheet.addRow(headers);

        // D·ªØ li·ªáu
        document.querySelectorAll("#bangChamCong tr").forEach(row => {
            const cells = [];
            
            // L·∫•y d·ªØ li·ªáu t·ª´ c√°c c·ªôt
            cells.push(row.cells[0].textContent.trim()); // M√£ NV
            cells.push(row.cells[1].textContent.trim()); // H·ªç t√™n
            cells.push(row.cells[2].textContent.trim()); // Ch·ª©c v·ª•
            cells.push(row.cells[3].querySelector("input").value); // Ng√†y l√†m vi·ªác (l·∫•y t·ª´ input)
            
            // L·∫•y gi√° tr·ªã L∆∞∆°ng/ng√†y t·ª´ data-value ƒë·ªÉ xu·∫•t s·ªë, kh√¥ng ph·∫£i chu·ªói ƒë·ªãnh d·∫°ng
            const luongNgayValue = parseInt(row.cells[4].getAttribute("data-value")); 
            cells.push(luongNgayValue); 

            // L·∫•y gi√° tr·ªã T·ªïng l∆∞∆°ng (c·∫ßn chuy·ªÉn t·ª´ chu·ªói ƒë·ªãnh d·∫°ng sang s·ªë)
            const tongLuongText = row.cells[5].textContent.trim();
            const tongLuongValue = parseInt(tongLuongText.replace(/[^0-9]/g, ''));
            cells.push(tongLuongValue); 

            worksheet.addRow(cells);
        });
        
        // C·∫•u h√¨nh c·ªôt v√† ƒë·ªãnh d·∫°ng
        
        // 1. Style Header
        const headerRow = worksheet.getRow(1);
        headerRow.height = 30;
        headerRow.eachCell(cell => {
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '1D72B8' } };
            cell.font = { name: 'Calibri', color: { argb: 'FFFFFF' }, bold: true, size: 12 };
            cell.alignment = { vertical: 'middle', horizontal: 'center' };
            cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
        });

        // 2. Style D·ªØ li·ªáu v√† ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
        worksheet.eachRow((row, rowNumber) => {
            if (rowNumber > 1) {
                const isEven = rowNumber % 2 === 0;
                const bgColor = isEven ? 'F8F8F8' : 'FFFFFF';
                row.height = 25;
                
                row.eachCell((cell, colNumber) => {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: bgColor } };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                    
                    // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá cho c·ªôt L∆∞∆°ng/ng√†y (C·ªôt E - s·ªë 5) v√† T·ªïng l∆∞∆°ng (C·ªôt F - s·ªë 6)
                    if (colNumber === 5 || colNumber === 6) {
                        cell.numFmt = '#,##0 " ‚Ç´"';
                        cell.alignment = { vertical: 'middle', horizontal: 'right' };
                    }
                    
                    // ƒê·ªãnh d·∫°ng ng√†y l√†m vi·ªác (C·ªôt D - s·ªë 4)
                    if (colNumber === 4) {
                        cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    }
                });
            }
        });

        // 3. Auto Width
        worksheet.columns.forEach(column => {
            let maxLength = 0;
            column.eachCell({ includeEmpty: true }, cell => {
                const text = cell.value ? cell.value.toString() : "";
                // Ch·ªâ l·∫•y chi·ªÅu d√†i c·ªßa M√£ NV, H·ªç T√™n, Ch·ª©c v·ª•
                if (column.number <= 3) {
                    maxLength = Math.max(maxLength, text.length);
                }
            });
            // Thi·∫øt l·∫≠p ƒë·ªô r·ªông t·ªëi thi·ªÉu cho c√°c c·ªôt
            if (column.number === 2) { column.width = 25; } // H·ªç t√™n
            else if (column.number === 3) { column.width = 15; } // Ch·ª©c v·ª•
            else if (column.number === 4) { column.width = 15; } // Ng√†y l√†m
            else if (column.number === 5) { column.width = 20; } // L∆∞∆°ng/ng√†y
            else if (column.number === 6) { column.width = 20; } // T·ªïng l∆∞∆°ng
            else { column.width = maxLength + 3; }
        });


        // Xu·∫•t file
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), "Bang_Luong_" + new Date().toISOString().slice(0, 10) + ".xlsx");
        alert("üì§ Xu·∫•t b·∫£ng l∆∞∆°ng th√†nh c√¥ng!");
    });
</script>